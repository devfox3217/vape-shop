<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
>

<th:block th:replace="admin/inc/head :: headFrg"></th:block>
<body class="bg-light">
<main>

    <th:block th:replace="admin/inc/header :: headerFrg"></th:block>

    <div class="container">
        <div class="row mb-3">
            <h1 class="mt-2 mb-4">상품관리</h1>
            <div class="col-12">
                <div class="btn-group">
                    <a th:href="@{/admin/product/list}" class="btn btn-primary">상품리스트</a>
                    <a th:href="@{/admin/product/insert}" class="btn btn-primary active">상품등록</a>
                </div>
            </div>
            <hr class="mt-3">
        </div>
        <div class="row">
            <div class="col-6 px-3">
                <form id="InsertProduct" method="post" th:action="@{/admin/setting/productInsert}" enctype="multipart/form-data">
                    <div class="row pt-3 pb-3">
                        <div class="col-8 mb-3">
                            <label class="form-label">타입<sup>*</sup> (먼저 선택 필수)</label>
                            <select onchange="typeSelected();specChanged()" id="TypeSelect" class="form-select" name="type" required>
                                <option value="">타입을 선택하세요</option>
                                <option value="liquid">액상</option>
                                <option value="device">기기</option>
                                <option value="etc">기타</option>
                            </select>
                        </div>
                        <div class="col-8 mb-3">
                            <label class="form-label">브랜드<sup>*</sup></label>
                            <select id="BrandSelect" onchange="brandChanged()" class="form-select" name="brand" required>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">상품명<sup>*(상품명은 한글로)</sup></label>
                                <input id="NameInput" onkeyup="nameChanged()" type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">보조상품명</label>
                                <input id="SubnameInput" onkeyup="subnameChanged()" type="text" class="form-control" name="subname">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">간단스펙<sup>*</sup></label>
                                <input id="SpecInput" onkeyup="specChanged()" type="text" class="form-control" name="spec" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">원가<sup>*</sup></label>
                                <input id="CostPriceInput" onkeyup="costPriceChanged()" type="text" class="form-control" name="cost_price" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">할인가</label>
                                <input id="DiscountPriceInput" onkeyup="discountPriceChanged()" type="text" class="form-control" name="discount_price">
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">재고수량<sup>*</sup></label>
                                <input id="RemainInput" type="text" class="form-control" name="remain" required>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="mb-3">
                                <label for="ThumbnailInput" class="form-label">썸네일 이미지<sup>*</sup></label>
                                <input id="ThumbnailInput" onchange="thumbnailChanged()" class="form-control" type="file" name="thumbnail" required>
                            </div>
                        </div>
                        <label class="form-label">상품설명 이미지<sup>*</sup>(입력칸 추가시 입력필수, 없을시 입력칸 삭제하기)</label>
                        <label>최소한 한개 이상은 필수생성 후 입력</label>
                        <div id="ImgInputContainer" class="col-12">

                        </div>

                        <div class="col-12 mb-4">
                            <button type="button" id="ImgAddBtn" onclick="addImgTab()" class="btn btn-sm btn-primary col-12">추가</button>
                        </div>
                        <hr>

                        <label class="form-label">카테고리 선택<sup>*</sup></label>
                        <div id="CategoryContainer" class="col-8 mb-3">

                        </div>

                    </div>
                </form>

            </div>
            <div class="col-6 px-3">
                <div class="row pt-3 pb-3">
                    <div class="col-12 mb-3">
                        <button class="btn btn-lg btn-success col-12" form="InsertProduct">이대로 등록하기</button>
                    </div>
                    <div class="col-4">
                        <img id="PreThumbnail" src="/img/placeholder.jpg" class="img-thumbnail" width="100%">
                    </div>
                    <div class="col-8 mb-4">
                        <h3 id="PreBrand"></h3>
                        <h1 id="PreName" class="mt-1"></h1>
                        <h4 id="PreSubname" class="mt-0"></h4>
                        <h5 id="PreSpec" class="mt-2 text-secondary"></h5>
                        <h5 class="text-muted mt-4">
                            <del id="PreCostPrice"></del>
                        </h5>
                        <h4 id="PreDiscoutPrice" class="text-success"></h4>
                    </div>
                    <div id="PreImgContainer" class="col-12">

                    </div>

                </div>
            </div>

        </div>

    </div>

    <th:block th:replace="admin/inc/footer :: footerFrg"></th:block>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script type="text/javascript">

    const csrfToken = document.querySelector('meta[name=\'_csrf\']')['content']

    const TypeSelect = document.getElementById('TypeSelect');
    const BrandSelect = document.getElementById('BrandSelect');
    const NameInput = document.getElementById('NameInput');
    const SubnameInput = document.getElementById('SubnameInput');
    const SpecInput = document.getElementById('SpecInput');
    const CostPriceInput = document.getElementById('CostPriceInput');
    const DiscountPriceInput = document.getElementById('DiscountPriceInput');
    const RemainInput = document.getElementById('RemainInput');
    const ThumbnailInput = document.getElementById('ThumbnailInput');
    const ImgInputContainer = document.getElementById('ImgInputContainer');
    const ImgAddBtn = document.getElementById('ImgAddBtn');
    const CategoryContainer = document.getElementById('CategoryContainer');

    const PreThumbnail = document.getElementById('PreThumbnail');
    const PreBrand = document.getElementById('PreBrand');
    const PreName = document.getElementById('PreName');
    const PreSubname = document.getElementById('PreSubname');
    const PreSpec = document.getElementById('PreSpec');
    const PreCostPrice = document.getElementById('PreCostPrice');
    const PreDiscountPrice = document.getElementById('PreDiscoutPrice');
    const PreImgContainer = document.getElementById('PreImgContainer');

    function brandChanged() {
        PreBrand.innerHTML = BrandSelect.options[BrandSelect.selectedIndex].text;
    }

    function nameChanged() {
        PreName.innerHTML = NameInput.value;
    }

    function subnameChanged() {
        PreSubname.innerHTML = SubnameInput.value;
    }

    function specChanged() {
        PreSpec.innerHTML = SpecInput.value;
    }

    function costPriceChanged() {
        if (DiscountPriceInput.value === '') {
            PreCostPrice.innerHTML = '';
            PreDiscountPrice.innerHTML = CostPriceInput.value + '원';
        } else {
            PreCostPrice.innerHTML = CostPriceInput.value + '원';
        }
    }

    function discountPriceChanged() {
        if (CostPriceInput.value !== '' && DiscountPriceInput.value === '') {
            costPriceChanged();
        } else {
            PreCostPrice.innerHTML = CostPriceInput.value + '원';
            PreDiscountPrice.innerHTML = DiscountPriceInput.value + '원';
        }
    }

    function thumbnailChanged() {
        if (ThumbnailInput.files && ThumbnailInput.files[0]) {

            const reader = new FileReader();

            reader.onload = e => {
                PreThumbnail.src = e.target.result
            }
            reader.readAsDataURL(ThumbnailInput.files[0])
        }
    }

    function imgChanged() {
        const tabList = document.getElementsByClassName('img-tab');
        let html = '';
        PreImgContainer.innerHTML = '';

        for (let i = 0; i < tabList.length; i++) {
            html += '<img class="img-preview" src="" width="100%">'
        }
        PreImgContainer.innerHTML = html;
        const preImgList = document.getElementsByClassName('img-preview');

        for (let i = 0; i < preImgList.length; i++) {
            const reader = new FileReader();
            reader.onload = e => {
                preImgList[i].src = e.target.result
            }
            reader.readAsDataURL(tabList[i].files[0]);
        }
    }

    function addImgTab() {
        const html = document.createRange().createContextualFragment(
            '<div class="row">' +
            '<div class="col-8">' +
            '<div class="mb-3">' +
            '<input class="form-control img-tab" onchange="imgChanged()" type="file" name="img" required>' +
            '</div>' +
            '</div>' +
            '<div class="col-4">' +
            '<button type="button" onclick="this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);imgChanged()" class="btn btn-danger delete-img">삭제</button>' +
            '</div>' +
            '</div>');
        ImgInputContainer.append(html);
    }

    function typeSelected() {
        const type = TypeSelect.value;

        if (type === "liquid") {
            SpecInput.value = "호흡|MG|ML";
            getCategory(type);
            getBrand(type);
        }

        if (type === "device") {
            SpecInput.value = "Max W";
            getCategory(type);
            getBrand(type);
        }

        if (type === "etc") {
            SpecInput.value = "";
            getCategory(type);
            getBrand(type);
        }

        if (type === "") {
            SpecInput.value = "";
            CategoryContainer.innerHTML = "";
        }

    }

    function getBrand(type) {

        fetch("/admin/setting/getBrands", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-XSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({
                type: TypeSelect.value
            })
        })
            .then((response) => response.json())
            .then((data) => {
                let html = '<option value="">브랜드를 선택하세요</option>';
                for (let item in data) {
                    if (type === data[item].type) {
                        const brandItem = '<option value="' + data[item].id + '">' + data[item].name + '</option>'
                        html += brandItem;
                    }
                }

                BrandSelect.innerHTML = html;
            })
    }

    function getCategory(type) {

        fetch("/admin/setting/getCategories", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-XSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({
                type: TypeSelect.value
            })
        })
            .then((response) => response.json())
            .then((data) => {
                let html = '';
                for (let high in data) {
                    if (data[high].ref === 0 && type === data[high].type) {
                        const highCategory = '<div class="title mt-3"><h4>' + data[high].name + '</h4></div>';
                        html += highCategory;
                        for (let row in data) {
                            if (data[high].id === data[row].ref) {
                                const rowCategory =
                                    '<div class="form-check">' +
                                    '<input class="form-check-input" type="checkbox" value="' + data[row].id + '" id="category' + data[row].id + '" name="category">' +
                                    '<label class="form-check-label" for="category' + data[row].id + '">' + data[row].name + '</label>' +
                                    '</div>';
                                html += rowCategory;
                            }
                        }

                    }
                }

                CategoryContainer.innerHTML = html;
            })
            .catch((error) =>
                console.log("error:", error)
            );
    }
</script>
</body>
</html>